<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M Countdown</title>
    <!-- Icon from https://icons8.com/icon/15693/stopwatch -->
    <link rel="icon" type="image/x-icon" href="icons8-stopwatch-96.png">
    <script src="papaparse.min.js"></script>
    <script>

    window.onload = function onLoad() {
        const url = getUrl();
        if (url) {
            fetchAndParse(url);
        } else {
            showUrlForm();
        }
    }

    function getUrl() {
        const params = (new URL(document.location)).searchParams;
        let source = params.get('source');
        if (source) {
            <!-- Google Spreadsheets does have a way to get csv files, but to make things easier for the user, we -->
            <!-- can massage the URL for them, so they can simply copy-paste -->
            if (source.startsWith('https://docs.google.com/spreadsheets/d/') && !source.endsWith('&output=csv')) {
                source = 'https://docs.google.com/spreadsheet/ccc?key=' + source.split('/')[5] + '&output=csv';
            }
            return source
        }
        return ""
    }

    function showUrlForm() {
        document.getElementById("urlForm").style.display = "block"
        document.getElementById("clearForm").style.display = "none"
    }

    function hideUrlForm() {
        document.getElementById("urlForm").style.display = "none"
        document.getElementById("clearForm").style.display = "block"
    }

    function showErrorText(err) {
        const errorTextElement = document.getElementById("errorText");
        errorTextElement.textContent = err;
        errorTextElement.style.display = "block"
    }

    function hideErrorText() {
        const errorTextElement = document.getElementById("errorText");
        errorTextElement.textContent = "";
        errorTextElement.style.display = "none"
    }

    function fetchAndParse(url){
        Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader:function(h) {
                return h.trim().toLowerCase()
            },
            complete: function(results) {
                parse(results.data);
            },
            error: function(err)
            {
                console.log(err);
                showErrorText(err);
                showUrlForm();
            },
        })
    }

    function parse(data) {
        let item;
        for (item of data) {
            const title = item['title'];
            const excludeWeekendsRaw = (item['skip weekends'] || 'false').toLowerCase();
            const excludeWeekends = (excludeWeekendsRaw === 'true' || excludeWeekendsRaw === 'yes' || excludeWeekendsRaw === 'y');
            const skipDays = getSkipDays(item);
            const days = countDown(new Date(item['date']), excludeWeekends, skipDays);
            const weekSize = excludeWeekends ? 5 : 7;
            const weeks = Math.ceil(days / weekSize);

            const div = document.getElementById("countdowns");
            const h = document.createElement("H1");
            h.appendChild(document.createTextNode(title));
            div.appendChild(h);
            const p1 = document.createElement("p");
            p1.appendChild(document.createTextNode("Days: " + days));
            div.appendChild(p1);
            const p2 = document.createElement("p");
            p2.appendChild(document.createTextNode("Weeks: " + weeks));
            div.appendChild(p2);
        }
        hideErrorText();
        hideUrlForm();
    }

    function countDown(endDate, excludeWeekends, skipDays) {
        const startDate = new Date();
        let numDays = 0;

        // Count days
        for (let currentDate = new Date(startDate); currentDate <= endDate; currentDate.setDate(currentDate.getDate() + 1)) {
          if (!excludeWeekends || currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
            numDays++;
          }
        }

        // Skip days off (by simply checking if they are between startDate and endDate)
        let skipDay;
        for (skipDay of skipDays) {
            if (startDate < skipDay && skipDay < endDate) {
                numDays--;
            }
        }

        return numDays;
    }

    function getSkipDays(item) {
        const skipDays = []
        let i = 0;
        // The first "duplicate" column doesn't have a suffix added to it
        let skipDate = item['skip date'];
        while (skipDate !== undefined && skipDate !== '') {
            skipDays.push(new Date(skipDate))
            i++
            skipDate = item['skip date_' + i]
        }
        return skipDays
    }

    function doExample() {
        const sourceElement = document.getElementById("source");
        sourceElement.value = "https://docs.google.com/spreadsheets/d/1WiAqdmNUpdFK9TNP__R8MHtbhNRjhG67PAY-nQC7roo/edit?pli=1#gid=0";
        const urlFormElement = document.getElementById("urlForm");
        urlFormElement.submit();
    }

    function doClear() {
        location.href = document.location.toString().split("?")[0]
    }
    </script>
</head>

<body>
<div id="errorText" style="display: none; color:red"></div>
<form id="urlForm" style="display: none;">
    <a href="../MCountdown" target="_blank">README</a>
    </br></br>
    <label for="source">URL:</label>
    <input type="text" id="source" name="source" value="" style="width:70%" placeholder="Enter URL of a correctly formatted CSV or Google Spreadsheet here...">
    </br>
    <input type="submit" value="Submit">
    </br></br>
    <input type="button" value="Load Example" onclick="doExample()">
    <a href="https://docs.google.com/spreadsheets/d/1WiAqdmNUpdFK9TNP__R8MHtbhNRjhG67PAY-nQC7roo/edit?pli=1#gid=0" target="_blank">See Example</a>
</form>
<div id="countdowns"></div>
<form id="clearForm" style="display: none;">
    <hr>
    <input type="button" value="Clear" onclick="doClear()">
</form>
</body>
</html>
